name: Dependabot Auto-Merge

on:
  workflow_run:
    # Must match the exact name of the CI/CD workflow
    workflows: ['CI/CD Pipeline']
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot-auto-merge:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Dependabot Workflow checks
        run: |
          PR_DATA=$(gh api repos/${{ github.repository }}/pulls --jq '.[] | select(.head.sha=="${{ github.event.workflow_run.head_sha }}")')
          PR_NUMBER=$(echo "$PR_DATA" | jq -r '.number')
          PR_URL=$(echo "$PR_DATA" | jq -r '.html_url')
          PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.user.login')

          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" == "null" ]; then
          echo "No matching PR found. Exiting."
          exit 1
          fi

          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          echo "PR_URL=$PR_URL" >> $GITHUB_ENV
          echo "PR_AUTHOR=$PR_AUTHOR" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Exit if PR was not created by Dependabot
        if: env.PR_AUTHOR != 'dependabot[bot]'
        run: exit 1

      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v1
        with:
          github-token: '${{ secrets.GITHUB_TOKEN }}'

      - name: Attempt Squash Merge
        if: success()
        run: gh pr merge --squash "$PR_URL" --merge --auto
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
